(function(){"use strict";const W={G:1,SOFTENING_SQ:.25};let e,i,c,m,k,f,g,F,r;const{G:B,SOFTENING_SQ:b}=W;function v(h){const p=Atomics.load(f,1);if(Atomics.add(f,0,1)+1===h)Atomics.store(f,0,0),Atomics.add(f,1,1),Atomics.notify(f,1);else for(;Atomics.load(f,1)===p;)Atomics.wait(f,1,p)}self.onmessage=h=>{const{type:p}=h.data;if(p==="init"){const{sharedBuffer:n,workerId:d,workerCount:a,maxBodies:l}=h.data;g=d,F=a,r=l;let o=0;e=new Float64Array(n,o,r*3),o+=r*3*8,i=new Float64Array(n,o,r*3),o+=r*3*8,c=new Float64Array(n,o,r*3),o+=r*3*8,m=new Float64Array(n,o,r),o+=r*8,k=new Float64Array(n,o,r),o+=r*8,f=new Int32Array(n,o,2),console.log(`Worker ${g} initialized.`)}if(p==="step"){const{count:n,dt:d}=h.data,a=.5*d,l=Math.ceil(n/F),o=g*l,w=Math.min(o+l,n);for(let s=o;s<w;s++){const t=s*3;i[t]+=c[t]*a,i[t+1]+=c[t+1]*a,i[t+2]+=c[t+2]*a,e[t]+=i[t]*d,e[t+1]+=i[t+1]*d,e[t+2]+=i[t+2]*d}v(F);for(let s=o;s<w;s++){const t=s*3;c[t]=0,c[t+1]=0,c[t+2]=0}const S=[];for(let s=o;s<w;s++){const t=s*3,A=e[t],u=e[t+1],x=e[t+2],I=k[s];let _=0,M=0,G=0;for(let y=0;y<n;y++){if(s===y)continue;const z=y*3,N=e[z]-A,j=e[z+1]-u,q=e[z+2]-x,P=N*N+j*j+q*q,T=P+b,E=Math.sqrt(T);if(s<y){const O=k[y];P<(I+O)**2&&S.push([s,y])}const C=B*m[y]/(T*E);_+=N*C,M+=j*C,G+=q*C}c[t]=_,c[t+1]=M,c[t+2]=G}S.length>0&&self.postMessage({type:"collisions",collisions:S});for(let s=o;s<w;s++){const t=s*3;i[t]+=c[t]*a,i[t+1]+=c[t+1]*a,i[t+2]+=c[t+2]*a}self.postMessage({type:"done"})}if(p==="energy"&&g===0){const{count:n}=h.data;let d=0,a=0;for(let l=0;l<n;l++){const o=l*3,w=i[o]**2+i[o+1]**2+i[o+2]**2;d+=.5*m[l]*w;const S=e[o],s=e[o+1],t=e[o+2];for(let A=l+1;A<n;A++){const u=A*3,x=S-e[u],I=s-e[u+1],_=t-e[u+2],M=Math.sqrt(x*x+I*I+_*_)+1e-6;a-=B*m[l]*m[A]/M}}self.postMessage({type:"energyResult",totalEnergy:{kinetic:d,potential:a,total:d+a}})}}})();
