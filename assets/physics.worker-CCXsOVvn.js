(function(){"use strict";let e,i,c,m,F,f,x,I,r;function v(h){const p=Atomics.load(f,1);if(Atomics.add(f,0,1)+1===h)Atomics.store(f,0,0),Atomics.add(f,1,1),Atomics.notify(f,1);else for(;Atomics.load(f,1)===p;)Atomics.wait(f,1,p)}self.onmessage=h=>{const{type:p}=h.data;if(p==="init"){const{sharedBuffer:n,workerId:d,workerCount:a,maxBodies:l}=h.data;x=d,I=a,r=l;let o=0;e=new Float64Array(n,o,r*3),o+=r*3*8,i=new Float64Array(n,o,r*3),o+=r*3*8,c=new Float64Array(n,o,r*3),o+=r*3*8,m=new Float64Array(n,o,r),o+=r*8,F=new Float64Array(n,o,r),o+=r*8,f=new Int32Array(n,o,2),console.log(`Worker ${x} initialized.`)}if(p==="step"){const{count:n,dt:d}=h.data,a=.5*d,l=Math.ceil(n/I),o=x*l,w=Math.min(o+l,n);for(let s=o;s<w;s++){const t=s*3;i[t]+=c[t]*a,i[t+1]+=c[t+1]*a,i[t+2]+=c[t+2]*a,e[t]+=i[t]*d,e[t+1]+=i[t+1]*d,e[t+2]+=i[t+2]*d}v(I);for(let s=o;s<w;s++){const t=s*3;c[t]=0,c[t+1]=0,c[t+2]=0}const u=[];for(let s=o;s<w;s++){const t=s*3,A=e[t],_=e[t+1],S=e[t+2],M=F[s];let g=0,k=0,N=0;for(let y=0;y<n;y++){if(s===y)continue;const z=y*3,j=e[z]-A,q=e[z+1]-_,G=e[z+2]-S,W=j*j+q*q+G*G,b=W+.25,C=Math.sqrt(b);if(s<y){const E=F[y];W<(M+E)**2&&u.push([s,y])}const B=1*m[y]/(b*C);g+=j*B,k+=q*B,N+=G*B}c[t]=g,c[t+1]=k,c[t+2]=N}u.length>0&&self.postMessage({type:"collisions",collisions:u});for(let s=o;s<w;s++){const t=s*3;i[t]+=c[t]*a,i[t+1]+=c[t+1]*a,i[t+2]+=c[t+2]*a}self.postMessage({type:"done"})}if(p==="energy"&&x===0){const{count:n}=h.data;let d=0,a=0;for(let l=0;l<n;l++){const o=l*3,w=i[o]**2+i[o+1]**2+i[o+2]**2;d+=.5*m[l]*w;const u=e[o],s=e[o+1],t=e[o+2];for(let A=l+1;A<n;A++){const _=A*3,S=u-e[_],M=s-e[_+1],g=t-e[_+2],k=Math.sqrt(S*S+M*M+g*g)+1e-6;a-=1*m[l]*m[A]/k}}self.postMessage({type:"energyResult",totalEnergy:d+a})}}})();
