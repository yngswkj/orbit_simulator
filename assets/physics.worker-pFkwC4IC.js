(function(){"use strict";const W={G:1,SOFTENING_SQ:.25};let e,i,c,m,k,f,S,F,r;const{G:B,SOFTENING_SQ:b}=W;function v(p){const h=Atomics.load(f,1);if(Atomics.add(f,0,1)+1===p)Atomics.store(f,0,0),Atomics.add(f,1,1),Atomics.notify(f,1);else for(;Atomics.load(f,1)===h;)Atomics.wait(f,1,h)}self.onmessage=p=>{const{type:h}=p.data;if(h==="init"){const{sharedBuffer:n,workerId:d,workerCount:a,maxBodies:l}=p.data;S=d,F=a,r=l;let s=0;e=new Float64Array(n,s,r*3),s+=r*3*8,i=new Float64Array(n,s,r*3),s+=r*3*8,c=new Float64Array(n,s,r*3),s+=r*3*8,m=new Float64Array(n,s,r),s+=r*8,k=new Float64Array(n,s,r),s+=r*8,f=new Int32Array(n,s,2),console.log(`Worker ${S} initialized.`),self.postMessage({type:"initDone",workerId:S})}if(h==="step"){const{count:n,dt:d}=p.data,a=.5*d,l=Math.ceil(n/F),s=S*l,w=Math.min(s+l,n);for(let o=s;o<w;o++){const t=o*3;i[t]+=c[t]*a,i[t+1]+=c[t+1]*a,i[t+2]+=c[t+2]*a,e[t]+=i[t]*d,e[t+1]+=i[t+1]*d,e[t+2]+=i[t+2]*d}v(F);for(let o=s;o<w;o++){const t=o*3;c[t]=0,c[t+1]=0,c[t+2]=0}const u=[];for(let o=s;o<w;o++){const t=o*3,A=e[t],_=e[t+1],x=e[t+2],M=k[o];let g=0,I=0,G=0;for(let y=0;y<n;y++){if(o===y)continue;const z=y*3,N=e[z]-A,j=e[z+1]-_,q=e[z+2]-x,P=N*N+j*j+q*q,T=P+b,E=Math.sqrt(T);if(o<y){const O=k[y];P<(M+O)**2&&u.push([o,y])}const C=B*m[y]/(T*E);g+=N*C,I+=j*C,G+=q*C}c[t]=g,c[t+1]=I,c[t+2]=G}u.length>0&&self.postMessage({type:"collisions",collisions:u});for(let o=s;o<w;o++){const t=o*3;i[t]+=c[t]*a,i[t+1]+=c[t+1]*a,i[t+2]+=c[t+2]*a}self.postMessage({type:"done"})}if(h==="energy"&&S===0){const{count:n}=p.data;let d=0,a=0;for(let l=0;l<n;l++){const s=l*3,w=i[s]**2+i[s+1]**2+i[s+2]**2;d+=.5*m[l]*w;const u=e[s],o=e[s+1],t=e[s+2];for(let A=l+1;A<n;A++){const _=A*3,x=u-e[_],M=o-e[_+1],g=t-e[_+2],I=Math.sqrt(x*x+M*M+g*g)+1e-6;a-=B*m[l]*m[A]/I}}self.postMessage({type:"energyResult",totalEnergy:{kinetic:d,potential:a,total:d+a}})}}})();
